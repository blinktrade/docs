# WebSocket API

With the WebSocket API, you have full access to the exchange, you can also check our JavaScript WebSocket
implementation [here](https://github.com/blinktrade/frontend/blob/master/jsdev/bitex/api/bitex.js#L760-L1784).

## Connectivity

The a rate limit is 16 messages per second.

```javascript

var BlinkTradeWS = require("blinktrade").BlinkTradeWS;
var blinktrade = new BlinkTradeWS({ prod: true });

```

### Heartbeat

You must send this message every 30 seconds to keep your connection alive.

> __EXAMPLE MESSAGE__

```json
{
    "MsgType": "1",
    "TestReqID": "1473241552307",
    "SendTime": 1469031953
}
```


```javascript

blinktrade.connect().then(function() {
  return blinktrade.heartbeat();
}).then(function(heartbeat) {
  console.log(heartbeat.Latency);
});

```

### Paratemers

Name      | Type   | Description
----------|--------|------------
MsgType   | string | [1](http://www.onixs.biz/fix-dictionary/4.4/msgType_1_1.html)
[TestReqID](http://www.onixs.biz/fix-dictionary/4.4/tagNum_112.html) | string | An ID assigned by you.
It can be any number. The response message associated with this request will contain the same ID
SendTime  | number | Unix Time Stamp


> __EXAMPLE RESPONSE__

```json

{
    "ServerTimestamp": 1473241957,
    "TestReqID": 1473241552307,
    "MsgType": "0",
    "SendTime": 1473241552307,
    "Latency": 167
}

```


### Response

Name            | Type   | Description
----------------|--------|------------
MsgType         | string | [0](http://www.onixs.biz/fix-dictionary/4.4/msgType_0_0.html)
[TestReqID](http://www.onixs.biz/fix-dictionary/4.4/tagNum_112.html) | string | This should match the TestReqID sent on the message
SendTime        | number | This should match your SendTime
ServerTimestamp | number | Server Unix Time Stamp

## Authentication

Most of WebSocket calls requires authentication, once you login with your username and password on the WebSocket connection,
you will be able to access your account. You can also login with your API Key and API Password and you'll only be
allowed to send messages that your API Key has permission to send.

### FingerPrint

If you're not using the JavaScript SDK, You will need to pass a fingerprint from your browser,
there's some finger prints implementations that you can use.

* [Our google closure implementation](https://github.com/blinktrade/frontend/blob/master/jsdev/bitex/util/util.js#L96-L157)
* [fingerprintjs2](https://github.com/Valve/fingerprintjs2)

### Login

> __EXAMPLE MESSAGE__

```json
{
    "MsgType": "BE",
    "UserReqID": 9696784,
    "BrokerID": 5,
    "Username": "TYD3ZilY0FDB1QdkD1iDdlqvcRdnV0sZILNh3D18ZKs",
    "Password": "ySIMrLdTqSDo3vL",
    "UserReqTyp": "1",
    "FingerPrint": "b959a35c7f3f5e9315c99b5a25c2bbda"
}
```

```javascript

blinktrade.connect().then(function() {
  return blinktrade.login({ username: "", password: "" });
}).then(function(logged) {
  console.log(logged);
});

```

### Parameters

Name                    | Type   | Description
------------------------|--------|------------
MsgType                 | string | [BE](http://www.onixs.biz/fix-dictionary/4.4/msgType_BE_6669.html)
UserReqID               | number | Request Id
BrokerID                | number | [\<BROKER_ID\>](#brokers)
Username                | string | The email address, username or API Key of the user
Password                | string | The password of the user
UserReqTyp              | string | "1"
FingerPrint             | string | Browser [fingerprint](#fingerprint)
SecondFactor            | number | **Optional**; Second Factor Authentication code generated by authy
UserAgent               | string | **Optional**; Browser user agent navigator
UserAgentLanguage       | string | **Optional**; User agent language
UserAgentTimezoneOffset | number | **Optional**; User agent timezone offset
UserAgentPlatform       | string | **Optional**; User agent platform

### Response

Returns a Login Model Object together with Profile and Broker information.

> __EXAMPLE RESPONSE__

```json
{
    "UserID": 90800003,
    "TwoFactorEnabled": false,
    "EmailLang": "pt_BR",
    "Username": "rodrigo",
    "IsMSB": false,
    "WithdrawFixedFee": null,
    "Broker": {},
    "Profile": {},
    "HasLineOfCredit": false,
    "UserStatus": 1,
    "IsBroker": false,
    "TakerTransactionFeeSell": null,
    "ConfirmationOrder": false,
    "TakerTransactionFeeBuy": null,
    "UserReqID": 9696784,
    "MsgType": "BF",
    "IsMarketMaker": false,
    "DepositPercentFee": null,
    "DepositFixedFee": null,
    "WithdrawPercentFee": null,
    "TransactionFeeBuy": null,
    "TransactionFeeSell": null,
    "EmailTwoFactorEnabled": false,
    "BrokerID": 5,
    "PermissionList": {
        "*": []
    }
}

```

Parameter               | Type   | Description
------------------------|--------|-------------
MsgType                 | string | [BF](http://www.onixs.biz/fix-dictionary/4.4/msgType_BF_6670.html)
Broker                  | object | Broker model object, see [broker response](#brokerlistgrp-model) for more informations
BrokerID                | number | [\<BROKER_ID\>](#brokers)
DepositFixedFee         | number | Fixed deposit fee
DepositPercentFee       | number | Deposit fixed fee
EmailLang               | string | Email Language
HasLineOfCredit         | boolean| `boolean` indicating whether user has line of credit
IsBroker                | boolean| `boolean` whether user is a broker
IsMSB                   | boolean|
Profile                 | object | Profile model object, see [profile model]() for more informations
TakerTransactionFeeBuy  | number | Taker fee for buy orders
TakerTransactionFeeSell | number | Taker fee for sell orders
TransactionFeeBuy       | number | Maker fee for buy orders
TransactionFeeSell      | number | Maker fee for sell orders
TwoFactorEnabled        | boolean| `boolean` indicating whether user has two factor enabled
UserID                  | number | Integer with the user ID
UserReqTyp              | number | Returns only if it's equal to 3 when password has been changed
UserStatus              | number | "1" = Logged In, "2" = Not Logged In, "3" = User Not Recognised
Username                | string | String with the username of the user
WithdrawFixedFee        | number | Fixed fee for withdrawals
WithdrawPercentFee      | number | Percent fee for withdrawals

## Subscribe to OrderBook

You can subscribe to one or more Symbols and receive one or more Market Data Entries in realtime.
Each Market Data Entry is composed by a bid, offer or a trade occurred.


> __EXAMPLE MESSAGE__

```json

{
    "MsgType": "V",
    "MDReqID": 9894272,
    "SubscriptionRequestType": "1",
    "MarketDepth": "0",
    "MDUpdateType": "1",
    "MDEntryTypes": ["0", "1", "2"],
    "Instruments": ["BTCBRL"]
}

```

```javascript

blinktrade.connect().then(function() {
  return blinktrade.subscribeOrderbook(["BTCUSD"]);
}).then(function(orderbook) {
  console.log(orderbook);
});

```

### Parameters

| Name                    | Type   | Description                                                        |
|-------------------------|--------|--------------------------------------------------------------------|
| MsgType                 | string | "V"                                                                |
| MDReqID                 | number | Request ID                                                         |
| SubscriptionRequestType | string | "1" = Subscribe, "2" = Unsubscribe                                 |
| MarketDepth             | string | "0" = Full Book, "1" = Top of Book                                 |
| [MDEntryTypes](http://www.onixs.biz/fix-dictionary/4.4/tagNum_269.html) | array(string) | "0" = Bid, "1" = Offer, "2" = Trade |
| [MDUpdateType](http://www.onixs.biz/fix-dictionary/4.4/tagNum_265.html) | string | "0" = Full Refresh, "1" = Incremental RefreshRefresh                                            |
| Instruments             | array(string) | Array with the symbols that you want to subscribe e.g.: ['BTCBRL'] |

### Response Full Book

| Name        | Type   | Description                    |
|-------------|--------|--------------------------------|
| MsgType     | string | "W"                            |
| MDReqID     | number | Request ID                     |
| MarketDepth | string | "0" = Full Book, "1" = Top of Book |
| Symbol      | string | Instrument symbol subscribed   |
| MDFullGrp   | object | Object containing all orders   |


> __EXAMPLE RESPONSE FULL ORDER BOOK__

```json

{
  "MDReqID": 9894272,
  "Symbol": "BTCUSD",
  "MsgType": "W",
  "MarketDepth": 0,
  "MDFullGrp": {
    "BTCUSD": {
      "bids": [[ 578, 1.59231429, 90800535 ], [ 577.79, 5.68, 90800535 ]],
      "asks": [[ 578.72, 8.32039144, 90800535 ], [ 579.67, 2, 90800535 ]]
    }
  }
}

```

While you are subscribed to incremental updates, you will receive bids, asks and trades occurred in realtime.

```javascript

blinktrade.subscribeOrderbook(["BTCUSD"])
  .on("OB:NEW_ORDER", function(order) {
}).on("OB:UPDATE_ORDER", function(order) {
}).on("OB:DELETE_ORDER", function(order) {
}).on("OB:DELETE_ORDERS_THRU", function(order) {
}).on("OB:TRADE_NEW", function(order) {
});

```

### Incremental Refresh Response

| Name     | Type   | Description                         |
|----------|--------|-------------------------------------|
| MsgType  | string | "X"                                 |
| MDReqID  | number | Request ID                          |
| MDBkTyp  | string | "3" = Order Depth                   |
| MDIncGrp | array  | Array containing the new data entry |

### Response MDIncGrp Entry

> __EXAMPLE RESPONSE__

```json

{
    "index": 19,
    "price": 550,
    "size": 0.05,
    "side": "buy",
    "userId": 90800003,
    "orderId": 1459028830971,
    "symbol": "BTCUSD",
    "time": "Wed Sep 07 2016 14:18:44 GMT-0300 (BRT)",
    "type": "OB:NEW_ORDER"
}

```

| Name              | Type   | Description                                                        |
|-------------------|--------|--------------------------------------------------------------------|
| OrderID           | number | Order ID                                                           |
| MDEntryPx         | number | Order Price                                                        |
| MDUpdateAction    | string | "0" = New, "1" = Update, "2" = Delete, "3" = Delete Thru           |
| MDEntryTime       | string | Time when order was created                                        |
| Symbol            | string | Order symbol that you have subscribed on market data e.g: "BTCUSD" |
| UserID            | number | User ID                                                            |
| Broker            | string | Broker name that order belongs to                                  |
| MDEntryType       | string | "0" = Bid, "1" = Offer, "2" = Trade                                |
| MDEntryPositionNo | number | Order position on the book                                         |
| MDEntrySize       | number | Order size amount                                                  |
| MDEntryID         | number | Market data entry ID                                               |
| MDEntryDate       | string | Date when market data was received                                 |

## Subscribe To Ticker

You can subscribe on one or more market symbols

> __EXAMPLE MESSAGE__

```json

{
    "MsgType": "e",
    "SecurityStatusReqID": 123,
    "SubscriptionRequestType": "1",
    "Instruments": ["BTCBRL"]
}

```

```js

blinktrade.subscribeTicker(["BLINK:BTCUSD"]).then(function(ticker) {
  console.log(ticker);
});

```

| Name                    | Type   | Description
|-------------------------|--------|------------
| MsgType                 | string | "e"
| SecurityStatusReqID     | number | Request ID
| SubscriptionRequestType | string | 1 = Snapshot + Updates (Subscribe)
| Instruments             | array  | Array containing the symbols that you want to subscribe


> __EXAMPLE RESPONSE__


```json

{
    "SellVolume": 0.71399999,
    "LowPx": 578,
    "LastPx": 578,
    "MsgType": "f",
    "BestAsk": 578.47,
    "HighPx": 578.71,
    "BuyVolume": 412.71463421,
    "BestBid": 578,
    "Symbol": "BTCUSD",
    "SecurityStatusReqID": 960751,
    "Market": "BLINK"
}

```

### Unsubscribe from ticker

To unsubscribe from ticker, you do the same as `unSubscribeOrderbook`, but passing `SecurityStatusReqID` to `unSubscribeTicker()`.

> __EXAMPLE MESSAGE__

```json

{
    "MsgType": "e",
    "SecurityStatusReqID": 960751,
    "SubscriptionRequestType": "2"
}

```

```javascript

blinktrade.subscribeTicker(["BLINK:BTCUSD"]).then(function(ticker) {
  // Note that there's no return when unsubscribe from ticker.
  blinktrade.unSubscribeTicker(ticker.SecurityStatusReqID);
});

```

### Response

Returns the given SecurityStatusReqID.

## Execution Report

You can listen to execution reports to get when your order has been updated.

```javascript

blinktrade.executionReport()
  .on("EXECUTION_REPORT:NEW", function(data) {
}).on("EXECUTION_REPORT:PARTIAL", function(data) {
}).on("EXECUTION_REPORT:EXECUTION", function(data) {
}).on("EXECUTION_REPORT:CANCELED", function(data) {
}).on("EXECUTION_REPORT:REJECTED", function(data) {
});


```

> __EXAMPLE RESPONSE__

```json

{
    "OrderID": 1459028830811,
    "ExecID": 740972,
    "ExecType": "0",
    "OrdStatus": "0",
    "CumQty": 0,
    "Symbol": "BTCUSD",
    "OrderQty": 5000000,
    "LastShares": 0,
    "LastPx": 0,
    "Price": 55000000000,
    "TimeInForce": "1",
    "LeavesQty": 5000000,
    "MsgType": "8",
    "ExecSide": "1",
    "OrdType": "2",
    "CxlQty": 0,
    "Side": "1",
    "ClOrdID": 3251968,
    "AvgPx": 0
}

```

### Response

field       | Type   | Description/Value
------------|--------|------------------
MsgType     | string | "8"
OrderID     | number | Unique identifier for Order as assigned by broker.
ExecID      | number | Unique identifier of execution message as assigned by broker.
ExecType    | string | "0" = New, "1" = Partially fill, "2" = Fill, "4" = Cancelled, "8" = Rejected, "A" = Pending New
OrdStatus   | string | "0" = New, "1" = Partially fill, "2 "= Fill, "4" = Cancelled, "8" = Rejected, "A" = Pending New
LeavesQty   | number | Quantity open for further execution.
Symbol      | string | Currency pair being used.
OrderQty    | number | Quantity ordered in satoshis.
LastShares  | number | Quantity of shares bought/sold on this fill.
LastPx      | number | Price of the last fill.
CxlQty      | number | Total quantity canceled for this order.
TimeInForce | string | "0" = Day, "1" = Good Till Cancel, "4" = Fill or Kill
CumQty      | number | Total quantity filled.
ClOrdID     | string | Unique identifier for Order as assigned by you
OrdType     | string | "2" = Limited
Side        | string | "1" = Buy, "2" = Sell
Price       | number | Price per unit of quantity in satoshis.
ExecSide    | string | Side of this fill.
AvgPx       | number | Calculated average price of all fills on this order.

### Events

| Event                      |  Description                                         |
|----------------------------|------------------------------------------------------|
| EXECUTION_REPORT:NEW       | Callback when you send a new order                   |
| EXECUTION_REPORT:PARTIAL   | Callback when your order has been partialy executed |
| EXECUTION_REPORT:EXECUTION | Callback when an order has been sussefully executed |
| EXECUTION_REPORT:CANCELED  | Callback when your order has been canceled          |
| EXECUTION_REPORT:REJECTED  | Callback when order has been rejected          |

## Deposit / Withdraw Refresh

When requesting deposits and withdraws, you can listen `DEPOSIT_REFRESH` and `WITHDRAW_REFRESH` receive updates.

```js

blinktrade.requestDeposit().on('DEPOSIT_REFRESH', function(deposit) {
  console.log(deposit);
});

blinktrade.requestWithdraw().on('WITHDRAW_REFRESH', function(withdraw) {
  console.log(withdraw);
});

```

<aside class="notice">
  <b>NOTE</b>
  <p>
    That these events will only be called to the current deposit / withdraw created,
    if you want to listen to any deposit / withdraw updates, you should use onDepositRefresh(callback)
    and onWithdrawRefresh(callback) instead.
  </p>
</aside>


```js

blinktrade.onDepositRefresh(function(deposit) {
  console.log(deposit);
});

blinktrade.onWithdrawRefresh(function(withdraw) {
  console.log(withdraw);
});

```

### Reponse

Returns a deposit / withdraw model

## Trade History

A list of the last trades executed on an exchange since a chosen date.

**NOTE** if you want to listen the last trades in real time, you should subscribe to market data instead.

```javascript

blinktrade.tradeHistory().then(function(trades) {
  console.log(trades);
});

```

### Parameters

| Name                | Type   | Description
|---------------------|--------|------------
| MsgType             | string | "U32"
| TradeHistoryReqID   | number | Request ID
| Since               | number | **Optional** Since
| Filter              | number | **Optional** Filter
| Page                | number | **Optional** defaults to 0.
| PageSize            | number | **Optional** defaults to 80.

> __EXAMPLE RESPONSE__

```json

{
    "TradeHistoryReqID": 1,
    "PageSize": 80,
    "TradeHistoryGrp": {
        "BTCBRL": [{
            "TradeID": 486649,
            "Market": "BTCBRL",
            "Side": "2",
            "Price": 202152000000,
            "Size": 76389217,
            "Buyer": 90869802,
            "Seller": 90863020,
            "Created": "2016-10-01 20:51:40"
        }]
    },
    "MsgType": "U33",
    "Page": 0
}

```
